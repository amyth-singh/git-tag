name: create-release-branch-from-develop

on:
  workflow_dispatch:
    inputs:
      increment_type:
        description: 'Type of version increment (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  versioning:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Get the latest version tag
        id: get_latest_version
        run: |
          latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1) || echo "v0.0.0")
          echo "Latest tag: $latest_tag"
          echo "::set-output name=latest_tag::$latest_tag"

      - name: Increment version
        id: increment_version
        run: |
          latest_tag="${{ steps.get_latest_version.outputs.latest_tag }}"
          version="${latest_tag#v}"
          IFS='.' read -r -a parts <<< "$version"
          major=${parts[0]}
          minor=${parts[1]}
          patch=${parts[2]}

          case "${{ github.event.inputs.increment_type }}" in
              major)
                  ((major++))
                  minor=0
                  patch=0
                  ;;
              minor)
                  ((minor++))
                  patch=0
                  ;;
              patch)
                  ((patch++))
                  ;;
              *)
                  echo "Invalid increment type: ${{ github.event.inputs.increment_type }}"
                  exit 1
                  ;;
          esac

          new_version="v$major.$minor.$patch"
          echo "New version: $new_version"
          echo "::set-output name=new_version::$new_version"

      - name: Create new branch with the incremented version
        run: |
          new_version="${{ steps.increment_version.outputs.new_version }}"
          branch_name="release-${{ github.event.inputs.increment_type }}-$new_version"
          git checkout -b $branch_name
          git push origin $branch_name

      - name: Create a new release (optional)
        if: github.event.inputs.increment_type == 'major'
        run: |
          new_version="${{ steps.increment_version.outputs.new_version }}"
          gh release create $new_version -t $new_version -n "Release $new_version"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
